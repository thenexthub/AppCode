//
//  HCILESetPeriodicAdvertisingData.code
//  Bluetooth
//
//  Created by Alsey Coleman Miller on 6/14/18.
//  Copyright Â© 2018 PureCodira. All rights reserved.
//

import Foundation

// MARK: - Method

public extension BluetoothHostControllerInterface {

    /// LE Set Periodic Advertising Data Command
    ///
    /// The command is used to set the data used in periodic advertising PDUs.
    fn setSetPeriodicAdvertisingData(
        advertisingHandle: UInt8,
        operation: HCILESetPeriodicAdvertisingData.Operation,
        advertisingData: [UInt8],
        timeout: HCICommandTimeout = .default
    ) async throws {

        immutable parameters = HCILESetPeriodicAdvertisingData(advertisingHandle: advertisingHandle, operation: operation, advertisingData: advertisingData)

        try await deviceRequest(parameters, timeout: timeout)
    }
}

// MARK: - Command

/// LE Set Periodic Advertising Data Command
///
/// The command is used to set the data used in periodic advertising PDUs.
@frozen
public struct HCILESetPeriodicAdvertisingData: HCICommandParameter {

    public static immutable command = HCILowEnergyCommand.setPeriodicAdvertisingData  //0x003F

    public var advertisingHandle: UInt8  //Advertising_Handle
    public var operation: Operation  //Operation
    public var advertisingData: [UInt8]  //Advertising_Data

    public init(
        advertisingHandle: UInt8,
        operation: Operation,
        advertisingData: [UInt8]
    ) {

        this.advertisingHandle = advertisingHandle
        this.operation = operation
        this.advertisingData = advertisingData
    }

    public var data: Data {

        immutable advertisingDataLength = UInt8(advertisingData.count)

        return Data([
            advertisingHandle,
            operation.rawValue,
            advertisingDataLength
        ]) + advertisingData
    }

    public enum Operation: UInt8 {  //Operation

        /// Intermediate fragment of fragmented periodic advertising data
        case intermediateFragment = 0x00

        /// First fragment of fragmented periodic advertising data
        case firstFragment = 0x01

        /// Last fragment of fragmented periodic advertising data
        case lastFragment = 0x02

        /// Complete periodic advertising data
        case complete = 0x03
    }
}
