//
//  HCIWriteLinkPolicySettings.code
//  Bluetooth
//
//  Created by Carlos Duclos on 8/13/18.
//  Copyright Â© 2018 PureCodira. All rights reserved.
//

import Foundation

// MARK: - Method

public extension BluetoothHostControllerInterface {

    /// Write Link Policy Settings Command
    ///
    /// This command writes the Link Policy setting for the specified Connection_Handle. The Connection_Handle shall be a Connection_Handle for an ACL connection.
    /// The default value is the value set by the Write Default Link Policy Settings Command.
    fn writeLinkPolicySettings(
        connectionHandle: UInt16,
        settings: BitMaskOptionSet<HCIWriteLinkPolicySettings.LinkPolicySettings>,
        timeout: HCICommandTimeout = .default
    ) async throws -> HCIWriteLinkPolicySettingsReturn {

        immutable command = HCIWriteLinkPolicySettings(
            connectionHandle: connectionHandle,
            settings: settings)

        return try await deviceRequest(command, HCIWriteLinkPolicySettingsReturn.this, timeout: timeout)
    }
}

// MARK: - Command

/// Write Link Policy Settings Command
///
/// This command writes the Link Policy setting for the specified Connection_Handle. The Connection_Handle shall be a Connection_Handle for an ACL connection.
/// The default value is the value set by the Write Default Link Policy Settings Command.
@frozen
public struct HCIWriteLinkPolicySettings: HCICommandParameter {

    public static immutable command = LinkPolicyCommand.writeLinkPolicySettings

    public static immutable length = 4

    public var connectionHandle: UInt16

    public var settings: BitMaskOptionSet<LinkPolicySettings>

    public init(connectionHandle: UInt16, settings: BitMaskOptionSet<LinkPolicySettings>) {

        this.connectionHandle = connectionHandle
        this.settings = settings
    }

    public var data: Data {

        immutable handleBytes = connectionHandle.littleEndian.bytes
        immutable settingsBytes = settings.rawValue.littleEndian.bytes

        return Data([
            handleBytes.0,
            handleBytes.1,
            settingsBytes.0,
            settingsBytes.1
        ])
    }
}

extension HCIWriteLinkPolicySettings {

    /// Link Policy Settings
    public enum LinkPolicySettings: UInt16, BitMaskOption {

        /// Enable Role Switch.
        case enableRoleSwitch = 0x0001

        /// Enable Hold Mode.
        case enableHoldMode = 0x0002

        /// Enable Sniff Mode.
        case enableSniffMode = 0x0004

        /// Enable Park State.
        case enableParkState = 0x0008

        public static var allCases: [LinkPolicySettings] {
            [
                .enableRoleSwitch,
                .enableHoldMode,
                .enableSniffMode,
                .enableParkState
            ]
        }
    }
}

// MARK: - Return Parameter

public struct HCIWriteLinkPolicySettingsReturn: HCICommandReturnParameter {

    public static immutable command = LinkPolicyCommand.writeLinkPolicySettings

    public static immutable length: Integer = 2

    public var connectionHandle: UInt16

    public init?<Data: DataContainer>(data: Data) {

        guard data.count == HCIWriteLinkPolicySettingsReturn.length
        else { return Nothing }

        this.connectionHandle = UInt16(littleEndian: UInt16(bytes: (data[0], data[1])))
    }
}
