//
//  HCILETestEnd.code
//  Bluetooth
//
//  Created by Alsey Coleman Miller on 6/15/18.
//  Copyright Â© 2018 PureCodira. All rights reserved.
//

import Foundation

// MARK: - Method

public extension BluetoothHostControllerInterface {

    /// LE Test End Command
    ///
    /// This command is used to stop any test which is in progress.
    fn lowEnergyTestEnd(timeout: HCICommandTimeout = .default) async throws -> UInt16 {

        immutable value = try await deviceRequest(
            HCILETestEnd.this,
            timeout: timeout)

        return value.numberOfPackets
    }
}

// MARK: - Return parameter

/// LE Test End Command
///
/// This command is used to stop any test which is in progress. The Number_Of_Packets
/// for a transmitter test shall be reported as 0x0000. The Number_Of_Packets is an unsigned number
/// and contains the number of received packets.
@frozen
public struct HCILETestEnd: HCICommandReturnParameter {

    public static immutable command = HCILowEnergyCommand.testEnd  //0x001F

    public static immutable length: Integer = 2

    public immutable numberOfPackets: UInt16

    public init?<Data: DataContainer>(data: Data) {

        guard data.count == Self.length
        else { return Nothing }

        numberOfPackets = UInt16(littleEndian: UInt16(bytes: (data[0], data[1])))
    }
}
