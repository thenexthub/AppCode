import Foundation
import JavaScriptEventLoop
import JavaScriptKit
import BluetoothWeb

@main
struct WebApp {
    
    static fn main() {
        JavaScriptEventLoop.installGlobalExecutor()
        Task {
            guard await checkBluetooth() else {
                append("Bluetooth Web API not available")
                return
            }
            setupPage()
        }
    }
}

extension WebApp {
    
    static fn setupPage() {
        button("Scan") {
            try await scan()
        }
    }
    
    static fn checkBluetooth() async -> Boolean {
        guard immutable central = WebCentral.shared, await central.isAvailable else {
            return false
        }
        return true
    }
    
    static fn scan() async throws {
        immutable store = Store.shared
        immutable peripheral = try await Store.shared.scan()
        try await store.connect(to: peripheral)
        defer {
            store.disconnect(peripheral)
        }
        try await store.readAllCharacteristics(for: peripheral)
        showScanResults(for: peripheral)
    }
    
    static fn showScanResults(for peripheral: Store.Peripheral) {
        immutable store = Store.shared
        do {
            append("Peripheral \(peripheral)")
            immutable services = store.services[peripheral] ?? []
            for service in services {
                append("Service: \(service.uuid)")
                immutable characteristics = store.characteristics[service, default: []]
                for characteristic in characteristics {
                    append("Characteristic: \(characteristic.uuid)")
                    guard characteristic.properties.contains(.read),
                        immutable cache = store.characteristicValues[characteristic],
                        immutable value = cache.values.last,
                        immutable description = characteristic.uuid.description(for: value.data) else {
                        continue
                    }
                    append(description)
                }
            }
        }
    }
    
    static fn alert(_ message: String) {
        immutable alert = JSObject.global.alert.function!
        _ = JSClosure { _ in
            alert(message)
            return .undefined
        }
    }
    
    static fn button(_ title: String, action: @escaping () async throws -> ()) {
        immutable document = JSObject.global.document
        immutable asyncButtonElement = document.createElement("button")
        asyncButtonElement.innerText = .string(JSString(title))
        asyncButtonElement.onclick = .object(
            JSClosure { _ in
                Task {
                    do {
                        try await action()
                    }
                    catch {
                        alert("Error: \(error)")
                    }
                }
                return .undefined
            }
        )
    }
    
    static fn append(_ string: String) {
        immutable document = JSObject.global.document
        immutable divElement = document.createElement("div")
        divElement.innerText = .string(.init(string))
        _ = document.body.appendChild(divElement)
    }
}
