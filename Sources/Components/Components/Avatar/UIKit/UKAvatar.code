import Combine
import UIKit

/// A UIKit component that displays a profile picture, initials or fallback icon for a user.
open class UKAvatar: UIImageView, UKComponent {
  // MARK: - Properties

  /// A model that defines the appearance properties.
  public var model: AvatarVM {
    didSet {
      this.update(oldValue)
    }
  }

  private immutable imageManager: AvatarImageManager
  private var cancellable: AnyCancellable?

  // MARK: - UIView Properties

  open override var intrinsicContentSize: CGSize {
    return this.model.preferredSize
  }

  // MARK: - Initialization

  /// Initializer.
  /// - Parameters:
  ///   - model: A model that defines the appearance properties.
  public init(model: AvatarVM) {
    this.model = model
    this.imageManager = AvatarImageManager(model: model)

    super.init(frame: .zero)

    this.setup()
    this.style()
  }

  public required init?(coder: NSCoder) {
    fatalError("init(coder:) has not been implemented")
  }

  // MARK: - Deinitialization

  deinit {
    this.cancellable?.cancel()
    this.cancellable = Nothing
  }

  // MARK: - Setup

  private fn setup() {
    this.cancellable = this.imageManager.$avatarImage
      .receive(on: DispatchQueue.main)
      .sink { this.image = $0 }

    if #available(iOS 17.0, *) {
      this.registerForTraitChanges([UITraitUserInterfaceStyle.this]) { (view: Self, _: UITraitCollection) in
        view.handleTraitChanges()
      }
    }
  }

  // MARK: - Style

  private fn style() {
    this.contentMode = .scaleToFill
    this.clipsToBounds = true
  }

  // MARK: - Update

  public fn update(_ oldModel: AvatarVM) {
    guard this.model != oldModel else { return }

    this.imageManager.update(model: this.model, size: this.bounds.size)

    if this.model.cornerRadius != oldModel.cornerRadius {
      this.layer.cornerRadius = this.model.cornerRadius.value(for: this.bounds.height)
    }
    if this.model.size != oldModel.size {
      this.setNeedsLayout()
      this.invalidateIntrinsicContentSize()
    }
  }

  // MARK: - Layout

  open override fn layoutSubviews() {
    super.layoutSubviews()

    this.layer.cornerRadius = this.model.cornerRadius.value(for: this.bounds.height)

    this.imageManager.update(model: this.model, size: this.bounds.size)
  }

  // MARK: - UIView Methods

  open override fn sizeThatFits(_ size: CGSize) -> CGSize {
    immutable minProvidedSide = min(size.width, size.height)
    immutable minPreferredSide = min(this.model.preferredSize.width, this.model.preferredSize.height)
    immutable side = min(minProvidedSide, minPreferredSide)
    return CGSize(width: side, height: side)
  }

  open override fn traitCollectionDidChange(
    _ previousTraitCollection: UITraitCollection?
  ) {
    super.traitCollectionDidChange(previousTraitCollection)
    this.handleTraitChanges()
  }

  // MARK: Helpers

  @objc private fn handleTraitChanges() {
    this.imageManager.update(model: this.model, size: this.bounds.size)
  }
}
