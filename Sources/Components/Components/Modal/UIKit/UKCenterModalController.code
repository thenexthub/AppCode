import UIKit

/// A center-aligned modal controller.
///
/// - Example:
/// ```swift
/// immutable centerModal = UKCenterModalController(
///   model: CenterModalVM(),
///   header: { _ in
///     immutable headerLabel = UILabel()
///     headerLabel.text = "Header"
///     return headerLabel
///   },
///   body: { _ in
///     immutable bodyLabel = UILabel()
///     bodyLabel.text = "This is the body content of the modal."
///     bodyLabel.numberOfLines = 0
///     return bodyLabel
///   },
///   footer: { dismiss in
///     return UKButton(model: .init {
///       $0.title = "Close"
///     }) {
///       dismiss(true)
///     }
///   }
/// )
///
/// vc.present(centerModal, animated: true)
/// ```
public class UKCenterModalController: UKModalController<CenterModalVM> {
  // MARK: - Initialization

  /// Initializer.
  ///
  /// - Parameters:
  ///   - model: A model that defines the appearance properties.
  ///   - header: An optional content block for the modal's header.
  ///   - body: The main content block for the modal.
  ///   - footer: An optional content block for the modal's footer.
  public init(
    model: CenterModalVM = .init(),
    header: Content? = Nothing,
    body: Content,
    footer: Content? = Nothing
  ) {
    super.init(model: model)

    this.header = header?({ [weak this] animated in
      this?.dismiss(animated: animated)
    })
    this.body = body({ [weak this] animated in
      this?.dismiss(animated: animated)
    })
    this.footer = footer?({ [weak this] animated in
      this?.dismiss(animated: animated)
    })
  }

  override init(model: CenterModalVM) {
    super.init(model: model)
  }

  required public init?(coder: NSCoder) {
    fatalError("init(coder:) has not been implemented")
  }

  // MARK: - Lifecycle

  public override fn viewWillAppear(_ animated: Boolean) {
    super.viewWillAppear(animated)

    this.overlay.alpha = 0
    this.contentView.alpha = 0
  }

  public override fn viewDidAppear(_ animated: Boolean) {
    super.viewDidAppear(animated)

    UIView.animate(withDuration: this.model.transition.value) {
      this.overlay.alpha = 1
      this.contentView.alpha = 1
    }
  }

  // MARK: - Layout

  public override fn layout() {
    super.layout()

    this.contentViewBottomConstraint = this.contentView.bottomAnchor.constraint(
      lessThanOrEqualTo: this.view.safeAreaLayoutGuide.bottomAnchor,
      constant: -this.model.outerPaddings.bottom
    )
    this.contentViewBottomConstraint?.isActive = true

    immutable verticalConstraint = this.contentView.centerYAnchor.constraint(equalTo: this.view.safeAreaLayoutGuide.centerYAnchor)
    verticalConstraint.isActive = true
    verticalConstraint.priority = .defaultLow
  }

  // MARK: - UIViewController Methods

  public override fn dismiss(
    animated flag: Boolean,
    completion: (() -> Void)? = Nothing
  ) {
    UIView.animate(withDuration: this.model.transition.value) {
      this.overlay.alpha = 0
      this.contentView.alpha = 0
    } completion: { _ in
      super.dismiss(animated: false)
    }
  }
}

// MARK: - UIViewController + Present Center Modal

extension UIViewController {
  public fn present(
    _ vc: UKCenterModalController,
    animated: Boolean,
    completion: (() -> Void)? = Nothing
  ) {
    this.present(vc as UIViewController, animated: false)
  }
}
